import{Fragment as Y,computed as O,defineComponent as B,h as G,inject as Z,nextTick as j,onMounted as _,onUnmounted as z,provide as ee,ref as k,toRaw as c,watch as J,watchEffect as W}from"vue";import{Features as U,render as N,omit as Q,compact as te}from'../../utils/render.js';import{useId as K}from'../../hooks/use-id.js';import{Keys as M}from'../../keyboard.js';import{calculateActiveIndex as oe,Focus as I}from'../../utils/calculate-active-index.js';import{dom as g}from'../../utils/dom.js';import{useOpenClosed as ne,State as q,useOpenClosedProvider as ae}from'../../internal/open-closed.js';import{match as A}from'../../utils/match.js';import{useResolveButtonType as le}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ie}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ue}from'../../utils/focus-management.js';import{useOutsideClick as re}from'../../hooks/use-outside-click.js';import{Hidden as se,Features as de}from'../../internal/hidden.js';import{objectToFormEntries as pe}from'../../utils/form.js';import{useControllable as fe}from'../../hooks/use-controllable.js';import{useTrackedPointer as be}from'../../hooks/use-tracked-pointer.js';import{isMobile as ve}from'../../utils/platform.js';import{disposables as me}from'../../utils/disposables.js';function ce(o,R){return o===R}var xe=(s=>(s[s.Open=0]="Open",s[s.Closed=1]="Closed",s))(xe||{}),Ce=(s=>(s[s.Single=0]="Single",s[s.Multi=1]="Multi",s))(Ce||{}),Oe=(s=>(s[s.Pointer=0]="Pointer",s[s.Other=1]="Other",s))(Oe||{});let X=Symbol("ComboboxContext");function H(o){let R=Z(X,null);if(R===null){let s=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,H),s}return R}let Ue=B({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>ce},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},form:{type:String,optional:!0},name:{type:String,optional:!0},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:R,attrs:s,emit:V}){let e=k(1),t=k(null),d=k(null),P=k(null),p=k(null),m=k({static:!1,hold:!1}),x=k([]),C=k(null),h=k(1),T=k(!1);function E(a=u=>u){let u=C.value!==null?x.value[C.value]:null,f=ue(a(x.value.slice()),v=>g(v.dataRef.domRef)),r=u?f.indexOf(u):null;return r===-1&&(r=null),{options:f,activeOptionIndex:r}}let n=O(()=>o.multiple?1:0),l=O(()=>o.nullable),[b,w]=fe(O(()=>o.modelValue===void 0?A(n.value,{[1]:[],[0]:void 0}):o.modelValue),a=>V("update:modelValue",a),O(()=>o.defaultValue)),S=null,D=null,i={comboboxState:e,value:b,mode:n,compare(a,u){if(typeof o.by=="string"){let f=o.by;return(a==null?void 0:a[f])===(u==null?void 0:u[f])}return o.by(a,u)},defaultValue:O(()=>o.defaultValue),nullable:l,inputRef:d,labelRef:t,buttonRef:P,optionsRef:p,disabled:O(()=>o.disabled),options:x,change(a){w(a)},activeOptionIndex:O(()=>{if(T.value&&C.value===null&&x.value.length>0){let a=x.value.findIndex(u=>!u.dataRef.disabled);a!==-1&&(C.value=a)}return C.value}),activationTrigger:h,optionsPropsRef:m,closeCombobox(){T.value=!1,!o.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(T.value=!0,o.disabled||e.value===0)return;let a=x.value.findIndex(u=>{let f=c(u.dataRef.value);return A(n.value,{[0]:()=>i.compare(c(i.value.value),c(f)),[1]:()=>c(i.value.value).some(v=>i.compare(c(v),c(f)))})});a!==-1&&(C.value=a),e.value=0},goToOption(a,u,f){S!==null&&cancelAnimationFrame(S),S=requestAnimationFrame(()=>{if(T.value=!1,o.disabled||p.value&&!m.value.static&&e.value===1)return;let r=E();if(r.activeOptionIndex===null){let y=r.options.findIndex(L=>!L.dataRef.disabled);y!==-1&&(r.activeOptionIndex=y)}let v=oe(a===I.Specific?{focus:I.Specific,id:u}:{focus:a},{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.disabled});C.value=v,h.value=f!=null?f:1,x.value=r.options})},selectOption(a){let u=x.value.find(r=>r.id===a);if(!u)return;let{dataRef:f}=u;w(A(n.value,{[0]:()=>f.value,[1]:()=>{let r=c(i.value.value).slice(),v=c(f.value),y=r.findIndex(L=>i.compare(v,c(L)));return y===-1?r.push(v):r.splice(y,1),r}}))},selectActiveOption(){if(i.activeOptionIndex.value===null)return;let{dataRef:a,id:u}=x.value[i.activeOptionIndex.value];w(A(n.value,{[0]:()=>a.value,[1]:()=>{let f=c(i.value.value).slice(),r=c(a.value),v=f.findIndex(y=>i.compare(r,c(y)));return v===-1?f.push(r):f.splice(v,1),f}})),i.goToOption(I.Specific,u)},registerOption(a,u){D&&cancelAnimationFrame(D);let f={id:a,dataRef:u},r=E(v=>(v.push(f),v));if(C.value===null){let v=u.value.value;A(n.value,{[0]:()=>i.compare(c(i.value.value),c(v)),[1]:()=>c(i.value.value).some(L=>i.compare(c(L),c(v)))})&&(r.activeOptionIndex=r.options.indexOf(f))}x.value=r.options,C.value=r.activeOptionIndex,h.value=1,r.options.some(v=>!g(v.dataRef.domRef))&&(D=requestAnimationFrame(()=>{let v=E();x.value=v.options,C.value=v.activeOptionIndex}))},unregisterOption(a){var f;i.activeOptionIndex.value!==null&&((f=i.options.value[i.activeOptionIndex.value])==null?void 0:f.id)===a&&(T.value=!0);let u=E(r=>{let v=r.findIndex(y=>y.id===a);return v!==-1&&r.splice(v,1),r});x.value=u.options,C.value=u.activeOptionIndex,h.value=1}};re([d,P,p],()=>i.closeCombobox(),O(()=>e.value===0)),ee(X,i),ae(O(()=>A(e.value,{[0]:q.Open,[1]:q.Closed})));let $=O(()=>i.activeOptionIndex.value===null?null:x.value[i.activeOptionIndex.value].dataRef.value),F=O(()=>{var a;return(a=g(d))==null?void 0:a.closest("form")});return _(()=>{J([F],()=>{if(!F.value||o.defaultValue===void 0)return;function a(){i.change(o.defaultValue)}return F.value.addEventListener("reset",a),()=>{var u;(u=F.value)==null||u.removeEventListener("reset",a)}},{immediate:!0})}),()=>{let{name:a,disabled:u,form:f,...r}=o,v={open:e.value===0,disabled:u,activeIndex:i.activeOptionIndex.value,activeOption:$.value,value:b.value};return G(Y,[...a!=null&&b.value!=null?pe({[a]:b.value}).map(([y,L])=>G(se,te({features:de.Hidden,key:y,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:f,name:y,value:L}))):[],N({theirProps:{...s,...Q(r,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:v,slots:R,attrs:s,name:"Combobox"})])}}}),qe=B({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${K()}`}},setup(o,{attrs:R,slots:s}){let V=H("ComboboxLabel");function e(){var t;(t=g(V.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:V.comboboxState.value===0,disabled:V.disabled.value},{id:d,...P}=o,p={id:d,ref:V.labelRef,onClick:e};return N({ourProps:p,theirProps:P,slot:t,attrs:R,slots:s,name:"ComboboxLabel"})}}}),_e=B({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${K()}`}},setup(o,{attrs:R,slots:s,expose:V}){let e=H("ComboboxButton");V({el:e.buttonRef,$el:e.buttonRef});function t(p){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(p.preventDefault(),e.openCombobox()),j(()=>{var m;return(m=g(e.inputRef))==null?void 0:m.focus({preventScroll:!0})}))}function d(p){switch(p.key){case M.ArrowDown:p.preventDefault(),p.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),j(()=>{var m;return(m=e.inputRef.value)==null?void 0:m.focus({preventScroll:!0})});return;case M.ArrowUp:p.preventDefault(),p.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),j(()=>{e.value.value||e.goToOption(I.Last)})),j(()=>{var m;return(m=e.inputRef.value)==null?void 0:m.focus({preventScroll:!0})});return;case M.Escape:if(e.comboboxState.value!==0)return;p.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&p.stopPropagation(),e.closeCombobox(),j(()=>{var m;return(m=e.inputRef.value)==null?void 0:m.focus({preventScroll:!0})});return}}let P=le(O(()=>({as:o.as,type:R.type})),e.buttonRef);return()=>{var h,T;let p={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:m,...x}=o,C={ref:e.buttonRef,id:m,type:P.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(h=g(e.optionsRef))==null?void 0:h.id,"aria-expanded":e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(T=g(e.labelRef))==null?void 0:T.id,m].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:d,onClick:t};return N({ourProps:C,theirProps:x,slot:p,attrs:R,slots:s,name:"ComboboxButton"})}}}),Je=B({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${K()}`}},emits:{change:o=>!0},setup(o,{emit:R,attrs:s,slots:V,expose:e}){let t=H("ComboboxInput"),d={value:!1};e({el:t.inputRef,$el:t.inputRef});let P=O(()=>{var l;let n=t.value.value;return g(t.inputRef)?typeof o.displayValue!="undefined"&&n!==void 0?(l=o.displayValue(n))!=null?l:"":typeof n=="string"?n:"":""});_(()=>{J([P,t.comboboxState],([n,l],[b,w])=>{if(d.value)return;let S=g(t.inputRef);S&&((w===0&&l===1||n!==b)&&(S.value=n),requestAnimationFrame(()=>{if(d.value||!S)return;let{selectionStart:D,selectionEnd:i}=S;Math.abs((i!=null?i:0)-(D!=null?D:0))===0&&D===0&&S.setSelectionRange(S.value.length,S.value.length)}))},{immediate:!0}),J([t.comboboxState],([n],[l])=>{if(n===0&&l===1){if(d.value)return;let b=g(t.inputRef);if(!b)return;let w=b.value,{selectionStart:S,selectionEnd:D,selectionDirection:i}=b;b.value="",b.value=w,i!==null?b.setSelectionRange(S,D,i):b.setSelectionRange(S,D)}})});let p=k(!1);function m(){p.value=!0}function x(){me().nextFrame(()=>{p.value=!1})}function C(n){switch(d.value=!0,n.key){case M.Backspace:case M.Delete:if(t.mode.value!==0||!t.nullable.value)return;let l=n.currentTarget;requestAnimationFrame(()=>{if(l.value===""){t.change(null);let b=g(t.optionsRef);b&&(b.scrollTop=0),t.goToOption(I.Nothing)}});break;case M.Enter:if(d.value=!1,t.comboboxState.value!==0||p.value)return;if(n.preventDefault(),n.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case M.ArrowDown:return d.value=!1,n.preventDefault(),n.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(I.Next),[1]:()=>t.openCombobox()});case M.ArrowUp:return d.value=!1,n.preventDefault(),n.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(I.Previous),[1]:()=>{t.openCombobox(),j(()=>{t.value.value||t.goToOption(I.Last)})}});case M.Home:if(n.shiftKey)break;return d.value=!1,n.preventDefault(),n.stopPropagation(),t.goToOption(I.First);case M.PageUp:return d.value=!1,n.preventDefault(),n.stopPropagation(),t.goToOption(I.First);case M.End:if(n.shiftKey)break;return d.value=!1,n.preventDefault(),n.stopPropagation(),t.goToOption(I.Last);case M.PageDown:return d.value=!1,n.preventDefault(),n.stopPropagation(),t.goToOption(I.Last);case M.Escape:if(d.value=!1,t.comboboxState.value!==0)return;n.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&n.stopPropagation(),t.closeCombobox();break;case M.Tab:if(d.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function h(n){R("change",n),t.openCombobox()}function T(){d.value=!1}let E=O(()=>{var n,l,b,w;return(w=(b=(l=o.defaultValue)!=null?l:t.defaultValue.value!==void 0?(n=o.displayValue)==null?void 0:n.call(o,t.defaultValue.value):null)!=null?b:t.defaultValue.value)!=null?w:""});return()=>{var i,$,F,a,u,f;let n={open:t.comboboxState.value===0},{id:l,displayValue:b,onChange:w,...S}=o,D={"aria-controls":(i=t.optionsRef.value)==null?void 0:i.id,"aria-expanded":t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||($=t.options.value[t.activeOptionIndex.value])==null?void 0:$.id,"aria-labelledby":(u=(F=g(t.labelRef))==null?void 0:F.id)!=null?u:(a=g(t.buttonRef))==null?void 0:a.id,"aria-autocomplete":"list",id:l,onCompositionstart:m,onCompositionend:x,onKeydown:C,onInput:h,onBlur:T,role:"combobox",type:(f=s.type)!=null?f:"text",tabIndex:0,ref:t.inputRef,defaultValue:E.value,disabled:t.disabled.value===!0?!0:void 0};return N({ourProps:D,theirProps:S,slot:n,attrs:s,slots:V,features:U.RenderStrategy|U.Static,name:"ComboboxInput"})}}}),We=B({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:R,slots:s,expose:V}){let e=H("ComboboxOptions"),t=`headlessui-combobox-options-${K()}`;V({el:e.optionsRef,$el:e.optionsRef}),W(()=>{e.optionsPropsRef.value.static=o.static}),W(()=>{e.optionsPropsRef.value.hold=o.hold});let d=ne(),P=O(()=>d!==null?(d.value&q.Open)===q.Open:e.comboboxState.value===0);return ie({container:O(()=>g(e.optionsRef)),enabled:O(()=>e.comboboxState.value===0),accept(p){return p.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:p.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(p){p.setAttribute("role","none")}}),()=>{var C,h,T;let p={open:e.comboboxState.value===0},m={"aria-labelledby":(T=(C=g(e.labelRef))==null?void 0:C.id)!=null?T:(h=g(e.buttonRef))==null?void 0:h.id,id:t,ref:e.optionsRef,role:"listbox","aria-multiselectable":e.mode.value===1?!0:void 0},x=Q(o,["hold"]);return N({ourProps:m,theirProps:x,slot:p,attrs:R,slots:s,features:U.RenderStrategy|U.Static,visible:P.value,name:"ComboboxOptions"})}}}),Ge=B({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:R,attrs:s,expose:V}){let e=H("ComboboxOption"),t=`headlessui-combobox-option-${K()}`,d=k(null);V({el:d,$el:d});let P=O(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),p=O(()=>A(e.mode.value,{[0]:()=>e.compare(c(e.value.value),c(o.value)),[1]:()=>c(e.value.value).some(l=>e.compare(c(l),c(o.value)))})),m=O(()=>({disabled:o.disabled,value:o.value,domRef:d}));_(()=>e.registerOption(t,m)),z(()=>e.unregisterOption(t)),W(()=>{e.comboboxState.value===0&&P.value&&e.activationTrigger.value!==0&&j(()=>{var l,b;return(b=(l=g(d))==null?void 0:l.scrollIntoView)==null?void 0:b.call(l,{block:"nearest"})})});function x(l){if(o.disabled)return l.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox(),ve()||requestAnimationFrame(()=>{var b;return(b=g(e.inputRef))==null?void 0:b.focus()})}function C(){if(o.disabled)return e.goToOption(I.Nothing);e.goToOption(I.Specific,t)}let h=be();function T(l){h.update(l)}function E(l){h.wasMoved(l)&&(o.disabled||P.value||e.goToOption(I.Specific,t,0))}function n(l){h.wasMoved(l)&&(o.disabled||P.value&&(e.optionsPropsRef.value.hold||e.goToOption(I.Nothing)))}return()=>{let{disabled:l}=o,b={active:P.value,selected:p.value,disabled:l},w={id:t,ref:d,role:"option",tabIndex:l===!0?void 0:-1,"aria-disabled":l===!0?!0:void 0,"aria-selected":p.value,disabled:void 0,onClick:x,onFocus:C,onPointerenter:T,onMouseenter:T,onPointermove:E,onMousemove:E,onPointerleave:n,onMouseleave:n};return N({ourProps:w,theirProps:o,slot:b,attrs:s,slots:R,name:"ComboboxOption"})}}});export{Ue as Combobox,_e as ComboboxButton,Je as ComboboxInput,qe as ComboboxLabel,Ge as ComboboxOption,We as ComboboxOptions};
